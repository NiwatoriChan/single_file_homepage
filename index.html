<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvel Onglet Personnalisé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Styles généraux */
        body {
            font-family: 'Inter', sans-serif; /* Police plus moderne */
        }

        /* Conteneur principal pour aligner les sections */
        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centre horizontalement */
            width: 100%;
            max-width: 1024px; /* Augmenter la largeur max pour plus d'espace */
            margin: 0 auto; /* Centrer le conteneur */
            padding: 1rem; /* Ajouter un peu de padding global */
        }

        /* Section Widgets */
        .widgets-section {
            width: 100%;
            margin-bottom: 2rem; /* Espace sous les widgets */
        }

        /* Styles communs pour les cartes de widget */
        .widget-card {
             background-color: #ffffff; /* white */
             border-radius: 0.5rem; /* rounded-lg */
             padding: 1rem; /* p-4 */
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
             border: 1px solid #e5e7eb; /* gray-200 */
             /* min-height: 100px; Supprimé pour laisser le contenu dicter la hauteur */
             display: flex;
             flex-direction: column;
        }

        /* Widget Horloge & Date */
        .clock-widget {
            justify-content: center; /* Centrer verticalement */
            align-items: center; /* Centrer horizontalement */
            text-align: center;
            min-height: 100px; /* Garder une hauteur min pour l'horloge */
        }
        .clock-widget .time {
            font-size: 2.5rem; /* text-4xl */
            font-weight: 600; /* semibold */
            color: #1f2937; /* gray-800 */
            line-height: 1.1;
        }
        .clock-widget .date {
            font-size: 1rem; /* text-base */
            color: #4b5563; /* gray-600 */
        }

        /* Widget Notes */
        .notes-widget {
             min-height: 150px; /* Donner un peu plus de hauteur min aux notes */
        }
        .notes-widget textarea {
            flex-grow: 1; /* Prendre l'espace disponible */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem; /* p-2 */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 0.5rem; /* mb-2 */
            resize: vertical; /* Permettre redimensionnement vertical */
            min-height: 80px; /* Hauteur minimale pour la zone de texte */
            outline: none;
        }
        .notes-widget textarea:focus {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        .notes-widget button {
            padding: 0.3rem 0.8rem;
            font-size: 0.75rem; /* text-xs */
            align-self: flex-end; /* Aligner le bouton à droite */
        }

        /* Widget Météo (Iframe) */
        .weather-widget-container {
            /* Laisser le widget s'afficher naturellement dans le padding de .widget-card */
            /* Supprimer les styles spécifiques .weatherwidget-io ajoutés précédemment */
            padding: 0; /* Le padding est déjà sur .widget-card */
        }


        /* Style pour les liens rapides */
        .quick-link {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* 16px */
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            text-decoration: none;
            color: #1f2937; /* gray-800 */
            overflow: hidden; /* Pour le nom du lien */
            aspect-ratio: 1 / 1; /* Pour rendre les tuiles carrées */
            cursor: grab; /* Indiquer qu'il est déplaçable */
        }
        .quick-link:active {
            cursor: grabbing; /* Curseur pendant le déplacement */
        }
        .quick-link.dragging {
            opacity: 0.5; /* Rendre l'élément semi-transparent pendant le drag */
            cursor: grabbing;
        }
        .quick-link.drag-over {
             /* Optionnel: Ajouter un style pour indiquer la zone de drop */
             border: 2px dashed #3b82f6; /* blue-500 */
        }

        .quick-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .quick-link img.favicon, .quick-link .default-favicon-container {
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            margin-bottom: 0.5rem; /* 8px */
            pointer-events: none; /* Empêcher l'image d'interférer avec le drag */
        }
        .quick-link img.favicon {
            border-radius: 0.25rem; /* rounded-sm */
            object-fit: contain; /* Éviter la déformation */
        }
         .quick-link span.link-name {
            font-size: 0.75rem; /* 12px */
            line-height: 1rem; /* 16px */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
            pointer-events: none; /* Empêcher le span d'interférer */
        }
        .delete-link-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            background-color: rgba(239, 68, 68, 0.8); /* bg-red-500 avec transparence */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem; /* 10px */
            cursor: pointer;
            opacity: 0; /* Caché par défaut */
            transition: opacity 0.2s ease;
            z-index: 10; /* S'assurer qu'il est au-dessus */
            /* Ne pas mettre pointer-events: none ici */
        }
        .quick-link:hover .delete-link-btn {
            opacity: 1; /* Visible au survol du lien */
        }
        .delete-link-btn:hover {
             background-color: #dc2626; /* red-600 */
        }

        /* Style pour le bouton Ajouter */
        .add-link-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* 16px */
            background-color: #ffffff; /* white */
            border: 2px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            text-align: center;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            cursor: pointer;
            color: #6b7280; /* gray-500 */
            aspect-ratio: 1 / 1; /* Pour rendre la tuile carrée */
        }
        .add-link-button:hover {
            border-color: #9ca3af; /* gray-400 */
            background-color: #f9fafb; /* gray-50 */
        }
        .add-link-button i {
            font-size: 1.5rem; /* 24px */
            margin-bottom: 0.5rem; /* 8px */
        }
         .add-link-button span {
            font-size: 0.75rem; /* 12px */
            line-height: 1rem; /* 16px */
        }

        /* Style pour le modal */
        .modal { background-color: rgba(0, 0, 0, 0.5); }
        .modal-content {
            max-width: 400px;
            width: 90%;
        }

        /* Style pour la barre de recherche */
         #searchForm {
             width: 100%; /* Prendre toute la largeur du conteneur */
             max-width: 600px; /* Limiter la largeur max de la barre */
             margin-left: auto; /* Centrer */
             margin-right: auto; /* Centrer */
             margin-bottom: 2rem; /* mb-8 */
         }
        #searchForm input[type="text"] {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        #searchForm button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        /* Favicon par défaut (SVG simple) */
        .default-favicon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb; /* gray-200 */
            border-radius: 0.25rem; /* rounded-sm */
            color: #9ca3af; /* gray-400 */
            pointer-events: none; /* Empêcher d'interférer */
        }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen">

    <div class="main-container">
        <form id="searchForm" class="flex" action="https://www.google.com/search" method="get" target="_blank">
            <input type="text" name="q" placeholder="Rechercher sur Google..." class="flex-grow p-3 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg" required>
            <button type="submit" class="bg-blue-500 text-white p-3 rounded-r-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                <i class="fas fa-search"></i>
            </button>
        </form>

        <div class="widgets-section">
             <h2 class="text-xl font-semibold text-gray-700 mb-4">Widgets</h2>
             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 <div class="widget-card clock-widget">
                     <div id="timeDisplay" class="time">--:--:--</div>
                     <div id="dateDisplay" class="date">----------</div>
                 </div>

                 <div class="widget-card notes-widget">
                     <h3 class="text-sm font-medium text-gray-600 mb-1">Notes rapides</h3>
                     <textarea id="notesTextArea" placeholder="Écrivez quelque chose..."></textarea>
                     <button id="saveNotesBtn" class="bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                         <i class="fas fa-save mr-1"></i> Sauvegarder
                     </button>
                 </div>

                 <div class="widget-card weather-widget-container">
                     <a class="weatherwidget-io" href="https://forecast7.com/fr/45d50n73d57/montreal/" data-label_1="MONTRÉAL" data-label_2="MÉTÉO" data-theme="pure" data-basecolor="ffffff" data-textcolor="#374151" data-lowcolor="#3b82f6" data-highcolor="#ef4444" style="display: block; position: relative; height: 100%; padding: 0 !important; margin: 0 !important;">MONTRÉAL MÉTÉO</a>
                     </div>
             </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md w-full">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Liens Rapides (Glisser-déposer pour réorganiser)</h2>
            <div id="quickLinksGrid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4">
                </div>
        </div>
    </div>

    <div id="addLinkModal" class="modal fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-lg font-semibold mb-4">Ajouter un nouveau lien</h3>
            <form id="addLinkForm">
                <div class="mb-4">
                    <label for="linkUrl" class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                    <input type="text" id="linkUrl" name="linkUrl" placeholder="example.com" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                     </div>
                <div class="mb-4">
                    <label for="linkName" class="block text-sm font-medium text-gray-700 mb-1">Nom du site (obligatoire)</label>
                    <input type="text" id="linkName" name="linkName" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelAddLinkBtn" class="px-4 py-2 bg-gray-300 rounded-md hover:bg-gray-400">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Éléments DOM ---
        const quickLinksGrid = document.getElementById('quickLinksGrid');
        const addLinkModal = document.getElementById('addLinkModal');
        const addLinkForm = document.getElementById('addLinkForm');
        const cancelAddLinkBtn = document.getElementById('cancelAddLinkBtn');
        const linkNameInput = document.getElementById('linkName');
        const linkUrlInput = document.getElementById('linkUrl');
        const timeDisplay = document.getElementById('timeDisplay');
        const dateDisplay = document.getElementById('dateDisplay');
        const notesTextArea = document.getElementById('notesTextArea');
        const saveNotesBtn = document.getElementById('saveNotesBtn');

        // --- Variables globales ---
        let quickLinks = [];
        const QUICK_LINKS_STORAGE_KEY = 'customHomepageLinks';
        const NOTES_STORAGE_KEY = 'customHomepageNotes';
        let clockInterval = null;
        let draggedItem = null;

        // --- Fonctions ---

        // --- Fonctions Liens Rapides ---
        function loadLinks() {
            const storedLinks = localStorage.getItem(QUICK_LINKS_STORAGE_KEY);
            if (storedLinks) {
                try {
                    quickLinks = JSON.parse(storedLinks);
                    if (!Array.isArray(quickLinks)) { quickLinks = []; }
                } catch (e) { quickLinks = []; console.error("Erreur parsing liens:", e); }
            } else {
                quickLinks = [
                    { name: "Google", url: "https://www.google.com" },
                    { name: "YouTube", url: "https://www.youtube.com" }, // URL corrigée
                    { name: "Wikipédia", url: "https://www.wikipedia.org" }
                ];
                saveLinks();
            }
            renderLinks();
            console.log("Liens chargés:", quickLinks.length);
        }

        function saveLinks() {
            try {
                localStorage.setItem(QUICK_LINKS_STORAGE_KEY, JSON.stringify(quickLinks));
                console.log("Liens sauvegardés.");
            } catch (e) { console.error("Erreur sauvegarde liens:", e); alert("Erreur sauvegarde liens."); }
        }

        function renderLinks() {
            quickLinksGrid.innerHTML = ''; // Vider complètement la grille
            quickLinks.forEach((link, index) => {
                const linkElement = createLinkElement(link, index);
                quickLinksGrid.appendChild(linkElement);
            });
            const addButtonElement = createAddButtonElement();
            quickLinksGrid.appendChild(addButtonElement);
        }

        function createLinkElement(link, index) {
            const a = document.createElement('a');
            a.href = link.url; // Utiliser l'URL formatée
            a.className = 'quick-link group';
            a.title = `${link.name}\n${link.url}`;
            a.target = "_blank"; a.rel = "noopener noreferrer";
            a.draggable = true;
            a.dataset.index = index;

            a.addEventListener('dragstart', handleDragStart);
            a.addEventListener('dragend', handleDragEnd);
            a.addEventListener('dragover', handleDragOver);
            a.addEventListener('dragenter', handleDragEnter);
            a.addEventListener('dragleave', handleDragLeave);
            a.addEventListener('drop', handleDrop);

            const faviconContainer = document.createElement('div');
            faviconContainer.className = 'favicon-container';
            const img = document.createElement('img');
            const faviconUrl = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(link.url)}&sz=32`;
            img.src = faviconUrl;
            img.alt = `Favicon for ${link.name}`;
            img.className = 'favicon';
            img.loading = 'lazy';
            img.onerror = function() {
                faviconContainer.innerHTML = `
                    <div class="default-favicon-container w-8 h-8 mb-2">
                        <i class="fas fa-link text-lg"></i>
                    </div>`;
            };
            faviconContainer.appendChild(img);
            a.appendChild(faviconContainer);

            const nameSpan = document.createElement('span');
            nameSpan.className = 'link-name';
            nameSpan.textContent = link.name;
            a.appendChild(nameSpan);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-link-btn';
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.title = 'Supprimer ce lien';
            deleteBtn.onclick = (e) => {
                e.preventDefault(); e.stopPropagation();
                const currentLinks = Array.from(quickLinksGrid.querySelectorAll('.quick-link'));
                const clickedIndex = currentLinks.indexOf(a);
                deleteLink(clickedIndex);
            };
            a.appendChild(deleteBtn);

            return a;
        }

        function createAddButtonElement() {
            const button = document.createElement('button');
            button.id = 'addLinkBtn';
            button.className = 'add-link-button';
            button.title = 'Ajouter un nouveau lien';
            button.innerHTML = `<i class="fas fa-plus"></i><span>Ajouter</span>`;
            button.addEventListener('click', openAddLinkModal);
            return button;
        }

        function formatUrl(inputUrl) {
            let url = inputUrl.trim();
            if (!url) return ''; // Retourner vide si l'input est vide

            // 1. Ajouter le protocole si absent
            if (!/^(?:f|ht)tps?:\/\//i.test(url)) {
                url = 'https://' + url;
            }

            // 2. Ajouter 'www.' si nécessaire après le protocole
            try {
                const urlObject = new URL(url);
                const isLocalOrIP = urlObject.hostname === 'localhost' || /^\d{1,3}(\.\d{1,3}){3}$/.test(urlObject.hostname);
                const hasSubdomain = urlObject.hostname.split('.').length > 2; // Simple check for existing subdomain

                // Ajouter www. seulement si pas local/IP et s'il n'y a pas déjà un sous-domaine (comme 'blog.example.com')
                if (!isLocalOrIP && !urlObject.hostname.startsWith('www.') && !hasSubdomain) {
                     url = `${urlObject.protocol}//www.${urlObject.hostname}${urlObject.pathname}${urlObject.search}${urlObject.hash}`;
                }
            } catch (e) {
                console.error("Erreur lors du parsing de l'URL pour ajouter www.:", e, url);
                // Retourner l'URL avec seulement le protocole ajouté si le parsing échoue
                 return url.startsWith('https://') ? url : inputUrl
